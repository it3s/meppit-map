/*!
* meppit-map
* v0.1.0 - 2014-05-02
* (c) 2014 it3s; MIT License
*/


(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p={}.hasOwnProperty,q=function(a,b){function c(){this.constructor=a}for(var d in b)p.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};null==window.Meppit&&(window.Meppit={}),window.Meppit.VERSION="0.1.0",i=Meppit.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)},j=Meppit.isNumber=function(a){return"number"==typeof a},k=Meppit.isString=function(a){return"string"==typeof a},h=Meppit.interpolate=function(a,b){return a.replace(/#{([^#{}]*)}/g,function(a,c){var d;return d=b[c],k(d)||j(d)?d:a})},g=Meppit.getHash=function(a){var b,c,d,e,f;if(c=0,a.length>0)for(d=e=0,f=a.length-1;f>=0?f>=e:e>=f;d=f>=0?++e:--e)b=a.charCodeAt(d),c=(c<<5)-c+b,c|=0;return"_"+c},f=Meppit.getDate=function(a){var b,c,d,e,f;return d=["January","February","March","April","May","June","July","August","September","October","November","December"],null==a&&(a=new Date),b=a.getDate(),c=a.getMonth()+1,f=a.getYear(),e=1e3>f?f+1900:f,""+d[c]+" "+b+" "+e},n=Meppit.log=function(){var a;return a=["["+f()+"]"].concat(Array.prototype.slice.call(arguments)),window.MEPPIT_SILENCE?void 0:"undefined"!=typeof console&&null!==console?console.log(a.join(" ")):void 0},o=Meppit.warn=function(){var a;return a=["["+f()+"]"].concat(Array.prototype.slice.call(arguments)),window.MEPPIT_SILENCE?void 0:"undefined"!=typeof console&&null!==console?console.warn(a.join(" ")):void 0},m=Meppit.reverseCoordinates=function(a){var b,c;return j(a)?a:i(a)&&i(a[0])?function(){var b,d,e;for(e=[],b=0,d=a.length;d>b;b++)c=a[b],e.push(m(c));return e}():i(a)&&j(a[0])?a.reverse():("Feature"===a.type?a.geometry.coordinates=m(a.geometry.coordinates):"FeatureCollection"===a.type&&(a.features=function(){var c,d,e,f;for(e=a.features,f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(m(b));return f}()),a)},l=Meppit.requestJSON=function(a,b){var c;return c=window.XMLHttpRequest?new XMLHttpRequest:window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):void 0,null==this._requests&&(this._requests=[]),this._requests.push(c),c.onreadystatechange=function(){return 4===c.readyState?b(200===c.status?JSON.parse(c.responseText):null):void 0},c.open("GET",a,!0),c.send()},e=0,a=function(){function a(){this.cid=e++}return a.prototype.VERSION="0.1.0",a.prototype.log=function(){var a;return a=["Log: "+this.constructor.name+"#"+this.cid+" -"].concat(Array.prototype.slice.call(arguments)),n.apply(this,a)},a.prototype.warn=function(){var a;return a=["Warn: "+this.constructor.name+"#"+this.cid+" -"].concat(Array.prototype.slice.call(arguments)),o.apply(this,a)},a.prototype.getOption=function(a){var b,c,d;return null!=(b=null!=(c=this.options)?c[a]:void 0)?b:null!=(d=this.defaultOptions)?d[a]:void 0},a.prototype.setOption=function(a,b){return null==this.options&&(this.options={}),this.options[a]=b},a}(),Meppit.BaseClass=a,"function"==typeof define&&define([],function(){return window.Meppit}),b=function(a){function b(a,c){this.map=a,this.options=null!=c?c:{},b.__super__.constructor.apply(this,arguments),this.log("Initializing Editor Manager..."),this._initToolbars(),this._uneditedLayerProps={}}return q(b,a),b.prototype.defaultOptions={drawControl:!1},b.prototype.edit=function(a,b){var c,d;return d=this.map._getLeafletLayer(a),null==this._currentLayer||this._currentLayer!==d?(this.done(),this._currentCallback=b,this._currentLayer=d,c=function(a){return function(){var b,c,d,e;if(a._currentLayer)return a._backupLayer(a._currentLayer),null!=(b=a._currentLayer)&&null!=(c=b.editing)&&c.enable(),null!=(d=a._currentLayer)&&null!=(e=d.dragging)&&e.enable(),a.map.editing=!0}}(this),this._currentLayer?c():this.map.load(a,function(b){return function(){return b._currentLayer=b.map._getLeafletLayer(a),c()}}(this))):void 0},b.prototype.draw=function(a,b){var c;return this.cancel(),this._currentCallback=b,this.map.editing=!0,c=k(a)?a:a.geometry.type,c=c.toLowerCase(),this._drawing="polygon"===c?new L.Draw.Polygon(this.map.leafletMap):"linestring"===c?new L.Draw.Polyline(this.map.leafletMap):new L.Draw.Marker(this.map.leafletMap),this.map.leafletMap.once("draw:created",function(c){return function(d){var e;return e=d.layer.toGeoJSON(),null!=a.properties&&(e.properties=a.properties),c.map.load(e),"function"==typeof b?b(e):void 0}}(this)),this._drawing.enable()},b.prototype.done=function(){var a,b;return this._currentLayer&&(null!=(a=this._currentLayer.editing)&&a.disable(),null!=(b=this._currentLayer.dragging)&&b.disable(),"function"==typeof this._currentCallback&&this._currentCallback(this._currentLayer.toGeoJSON())),this._currentCallback=this._currentLayer=void 0,this.map.editing=!1},b.prototype.cancel=function(){return this._revertLayer(this._currentLayer),this.done(),this.map.editing=!1},b.prototype._initToolbars=function(){return this.getOption("drawControl")?this._initEditToolbar():void 0},b.prototype._initEditToolbar=function(){return this.drawnItems=this.map._ensureGeoJsonManager(),this.drawControl=new L.Control.Draw({edit:{featureGroup:this.drawnItems}}),this.map._addLeafletControl(this.drawControl)},b.prototype._backupLayer=function(a){var b;if(b=L.Util.stamp(a),!this._uneditedLayerProps[b]){if(a instanceof L.Polyline||a instanceof L.Polygon)return this._uneditedLayerProps[b]={latlngs:L.LatLngUtil.cloneLatLngs(a.getLatLngs())};if(a instanceof L.Marker)return this._uneditedLayerProps[b]={latlng:L.LatLngUtil.cloneLatLng(a.getLatLng())}}},b.prototype._revertLayer=function(a){var b;if(null!=a&&(b=L.Util.stamp(a),a.edited=!1,this._uneditedLayerProps.hasOwnProperty(b))){if(a instanceof L.Polyline||a instanceof L.Polygon)return a.setLatLngs(this._uneditedLayerProps[b].latlngs);if(a instanceof L.Marker)return a.setLatLng(this._uneditedLayerProps[b].latlng)}},b}(a),window.Meppit.EditorManager=b,c=function(a){function b(a){this.options=null!=a?a:{},b.__super__.constructor.apply(this,arguments),this.log("Initializing Map"),this.editing=!1,this._ensureLeafletMap(),this._ensureTileProviders(),this._ensureGeoJsonManager(),this.__defineLeafletDefaultImagePath(),this.selectTileProvider(this.getOption("tileProvider"))}return q(b,a),b.prototype.defaultOptions={element:document.createElement("div"),zoom:14,center:[-23.5,-46.6167],tileProvider:"map",idPropertyName:"id",urlPropertyName:"url",featureURL:"#{baseURL}features/#{id}",geojsonTileURL:"#{baseURL}geoJSON/{z}/{x}/{y}",enableEditor:!0,enablePopup:!0,enableGeoJsonTile:!0},b.prototype.destroy=function(){return this.leafletMap.remove()},b.prototype.load=function(a,b){return j(a)?this.load(this.getURL(a),b):k(a)?l(a,function(a){return function(c){return c?a.load(c,b):"function"==typeof b?b(null):void 0}}(this)):(this._geoJsonManager.addData(a),"function"==typeof b&&b(a)),this},b.prototype.show=function(a,b){return this.load(a,function(a){return function(c){return a.fit(c),"function"==typeof b?b(c):void 0}}(this)),this},b.prototype.toGeoJSON=function(){return this._geoJsonManager.toGeoJSON()},b.prototype.get=function(a){var b;return null!=(b=this._getLeafletLayer(a))?b.toGeoJSON():void 0},b.prototype.remove=function(a){var b,c,d,e,f,g,h;if("FeatureCollection"===a.type)for(g=a.features,e=0,f=g.length;f>e;e++)b=g[e],this.remove(b);else d=this._getLeafletLayer(a),this.leafletMap.removeLayer(d),this.__clearLayerEventListeners(d),c=d.toGeoJSON(),null!=(h=this.leafletLayers)&&(h[this._getGeoJSONId(null!=c?c:this._getGeoJSONHash(c))]=void 0);return this},b.prototype.edit=function(a,b){var c;return this.closePopup(),this.panTo(a),null!=(c=this._ensureEditorManager())&&c.edit(a,b),this},b.prototype.draw=function(a,b){var c;return this.closePopup(),null!=(c=this._ensureEditorManager())&&c.draw(a,b),this},b.prototype.done=function(){var a;return null!=(a=this._editorManager)&&a.done(),this},b.prototype.cancel=function(){var a;return null!=(a=this._editorManager)&&a.cancel(),this},b.prototype.openPopup=function(a,b){return this.openPopupAt(a,b),this},b.prototype.openPopupAt=function(a,b,c){var d;return null!=(d=this._ensurePopupManager())&&d.open(a,b,c),this},b.prototype.closePopup=function(){var a;return null!=(a=this._ensurePopupManager())&&a.close(),this},b.prototype.fit=function(a){var b;if(null!=a)return b=this._getBounds(a),null!=b&&this.leafletMap.fitBounds(b),this},b.prototype.panTo=function(a){var b;if(null!=a)return b=this._getBounds(a),null!=b&&this.leafletMap.panInsideBounds(b),this},b.prototype.selectTileProvider=function(a){var b;return null!=(b=this.tileProviders[a])&&b.addTo(this.leafletMap),this.currentTileProvider=a,this},b.prototype.clear=function(){return this._geoJsonManager.clearLayers(),this.leafletLayers={},this},b.prototype.getZoom=function(){return this.leafletMap.getZoom.apply(this.leafletMap,arguments)},b.prototype.setZoom=function(){return this.leafletMap.setZoom.apply(this.leafletMap,arguments),this},b.prototype.zoomIn=function(){return this.leafletMap.zoomIn.apply(this.leafletMap,arguments),this},b.prototype.zoomOut=function(){return this.leafletMap.zoomOut.apply(this.leafletMap,arguments),this},b.prototype.getURL=function(a){var b,c;return b=null!=a&&null!=(c=a.properties)?c[this.getOption("urlPropertyName")]:void 0,null!=b?b:(b=h(this.getOption("featureURL"),{baseURL:this._getBaseURL()}),h(b,{id:this._getGeoJSONId(a)}))},b.prototype._getBounds=function(a){var b,c,d,e,f,g;for(d="FeatureCollection"===a.type?a.features.slice():[a],b=void 0,f=0,g=d.length;g>f;f++)c=d[f],e=this._getLeafletLayer(c),null!=e&&(null!=e.getBounds?(null==b&&(b=e.getBounds()),b.extend(e.getBounds())):null!=e.getLatLng&&(null==b&&(b=L.latLngBounds([e.getLatLng()])),b.extend(e.getLatLng())));return b},b.prototype._getBaseURL=function(){var a,b,c;return b=document.getElementsByTagName("base"),a="index.html",c=this.getOption("baseURL"),null!=c?c:b.length>0?b[0].href.replace(a,""):location.protocol+"//"+location.hostname+(""!==location.port?":"+location.port:"")+"/"},b.prototype._getGeoJsonTileURL=function(){return h(this.getOption("geojsonTileURL"),{baseURL:this._getBaseURL()})},b.prototype._ensureLeafletMap=function(){return null==this.element&&(this.element=k(this.getOption("element"))?document.getElementById(this.getOption("element")):this.getOption("element")),null!=this.leafletMap?this.leafletMap:this.leafletMap=new L.Map(this.element,this.__getLeafletMapOptions())},b.prototype._ensureGeoJsonManager=function(){var a,b,c;return null==this.leafletLayers&&(this.leafletLayers={}),a=function(a){return function(b,c){return a.__saveFeatureLayerRelation(b,c),a.__addLayerEventListeners(b,c)}}(this),c=function(){return function(){}}(this),b={style:c,onEachFeature:a},this.getOption("enableGeoJsonTile")&&null==this.__geoJsonTileLayer&&(this.__geoJsonTileLayer=new L.TileLayer.GeoJSON(this._getGeoJsonTileURL(),{clipTiles:!0,unique:function(a){return function(b){return a._getGeoJSONId(b)}}(this)},b).addTo(this.leafletMap)),null!=this._geoJsonManager?this._geoJsonManager:this._geoJsonManager=new L.GeoJSON([],b).addTo(this.leafletMap)},b.prototype._ensureEditorManager=function(){var a;return this.getOption("enableEditor")?(null==this._editorManager&&(this._editorManager=null!=(a="function"==typeof Meppit.EditorManager?new Meppit.EditorManager(this,this.options):void 0)?a:this.warn("Editor manager have not been loaded")),this._editorManager):void this.warn("Editor manager have been disabled")},b.prototype._ensurePopupManager=function(){var a;return this.getOption("enablePopup")?(null==this._popupManager&&(this._popupManager=null!=(a="function"==typeof Meppit.PopupManager?new Meppit.PopupManager(this,this.options):void 0)?a:this.warn("Popup manager have not been loaded")),this._popupManager):void this.warn("Popup manager have been disabled")},b.prototype._ensureTileProviders=function(){var a,b;return null==this.tileProviders&&(this.tileProviders={}),null==(a=this.tileProviders).map&&(a.map=new L.TileLayer("http://{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png",{attribution:'Data, imagery and map information provided by <a href="http://www.mapquest.com/">MapQuest</a>, <a href="http://www.openstreetmap.org/">Open Street Map</a> and contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>.',subdomains:["otile1","otile2","otile3","otile4"]})),null==(b=this.tileProviders).satellite&&(b.satellite=new L.TileLayer("http://{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.jpg",{attribution:'Data and imagery provided by <a href="http://www.mapquest.com/">MapQuest</a>a>. Portions Courtesy NASA/JPL-Caltech and U.S. Depart. of Agriculture, Farm Service Agency.',subdomains:["otile1","otile2","otile3","otile4"]})),this.tileProviders},b.prototype._addLeafletControl=function(){return this.leafletMap.addControl.apply(this.leafletMap,arguments)},b.prototype._getGeoJSONId=function(a){var b;return j(a)?a:null!=(b=a.properties)?b[this.getOption("idPropertyName")]:void 0},b.prototype._getGeoJSONHash=function(a){return g(JSON.stringify(a))},b.prototype._getLeafletLayer=function(a){var b;return j(a)||k(a)?this.leafletLayers[a]:null!=a?this._getLeafletLayer(null!=(b=this._getGeoJSONId(a))?b:this._getGeoJSONHash(a)):void 0},b.prototype.__addLayerEventListeners=function(a,b){return b.on("click",function(b){return function(c){return b.openPopupAt(a,void 0,c.latlng)}}(this))},b.prototype.__clearLayerEventListeners=function(a){return a.off("click")},b.prototype.__getLeafletMapOptions=function(){return{center:this.getOption("center"),zoom:this.getOption("zoom")}},b.prototype.__saveFeatureLayerRelation=function(a,b){var c,d,e;return c=null!=(d=null!=(e=a.properties)?e.id:void 0)?d:this._getGeoJSONHash(a),this.leafletLayers[c]=b},b.prototype.__defineLeafletDefaultImagePath=function(){var a,b,c,d,e,f,g;if(null==L.Icon.Default.imagePath)for(d=document.getElementsByTagName("script"),a=/[\/^]meppit-map[\-\._]?([\w\-\._]*)\.js\??/,f=0,g=d.length;g>f;f++)if(c=d[f],e=c.src,e.match(a))return b=e.split(a)[0],void(L.Icon.Default.imagePath=(b?b+"/":"")+"images")},b}(a),window.Meppit.Map=c,d=function(a){function b(a,b){this.map=a,this.options=b,this._createPopup()}return q(b,a),b.prototype.defaultOptions={popupTemplate:'<h1 class="title"><a href="#{url}">#{name}</a></h1>'},b.prototype.open=function(a,b,c){var d;if(!this.map.editing&&(d=this.map._getLeafletLayer(a),null!=d))return null==c&&(c=null!=d.getLatLng?d.getLatLng():null!=d.getBounds?d.getBounds().getCenter():void 0),this._popup.setLatLng(c),this._popup.setContent(null!=b?b:this._getContent(d.toGeoJSON())),this._popup.openOn(this.map.leafletMap)},b.prototype.close=function(){return this.map.leafletMap.closePopup(this._popup)},b.prototype._getContent=function(a){var b,c,d,e;return a?(c=null!=(d=null!=(e=a.properties)?e.popupContent:void 0)?d:this.getOption("popupTemplate"),b=h(c,a.properties),b=h(b,{url:this.map.getURL(a)})):""},b.prototype._createPopup=function(){return this._popup=new L.Popup},b}(a),window.Meppit.PopupManager=d}).call(this);
//# sourceMappingURL=meppit-map.min.map